#include "laguerre_transform.h"
#include "gtest/gtest.h"
#include "device_test.h"
#include "parameters.h"
#include "grids.h"
#include "cuda_constants.h"

class TestLaguerreTransform : public ::testing::Test {
protected:
  virtual void SetUp() {
    Parameters* pars = new Parameters;
    pars->nx_in = 20;
    pars->ny_in = 48;
    pars->nz_in = 32;
    pars->nspec_in = 1;
    pars->nm_in = 4;
    pars->nl_in = 9; // leave this value
    pars->Zp = 1.;
    pars->x0 = 10.;
    pars->y0 = 10.;

    grids = new Grids(pars);
    laguerre = new LaguerreTransform(grids,pars->nm_in);
    L = grids->Nl - 1;
    J = (3*L-1)/2;
  }

  virtual void TearDown() {
    delete grids;
    delete laguerre;
  }

  Grids *grids;
  LaguerreTransform *laguerre;
  int L, J;
};

TEST_F(TestLaguerreTransform, toGrid) {
  float toGrid_correct[108] = {
  8.9072e-01,	-7.8765e-01,	6.9053e-01,	-5.9916e-01,	5.1329e-01,	-4.3271e-01,	3.5722e-01,	-2.8661e-01,	2.2068e-01,	
  5.4240e-01,	-2.1058e-01,	-1.9739e-02,	1.6926e-01,	-2.5551e-01,	2.9326e-01,	-2.9481e-01,	2.7037e-01,	-2.2832e-01,	
  2.2033e-01,	1.1295e-01,	-1.9416e-01,	1.5041e-01,	-6.0719e-02,	-2.9404e-02,	9.7094e-02,	-1.3413e-01,	1.4118e-01,	
  5.8792e-02,	1.0781e-01,	-3.8358e-02,	-4.4176e-02,	7.4780e-02,	-5.6882e-02,	1.5102e-02,	2.6823e-02,	-5.4006e-02,	
  1.0060e-02,	3.6207e-02,	2.3922e-02,	-2.7334e-02,	-1.5358e-03,	2.3219e-02,	-2.3490e-02,	8.2885e-03,	9.7776e-03,	
  1.0653e-03,	6.2260e-03,	1.1435e-02,	2.8803e-03,	-8.6885e-03,	1.4413e-03,	6.2422e-03,	-6.7245e-03,	1.3933e-03,	
  6.6300e-05,	5.7160e-04,	1.8592e-03,	2.4829e-03,	2.3273e-04,	-1.9574e-03,	2.5583e-04,	1.5543e-03,	-1.2689e-03,	
  2.2467e-06,	2.6974e-05,	1.3383e-04,	3.3916e-04,	4.0888e-04,	5.6274e-05,	-3.2192e-04,	-4.8513e-05,	2.9377e-04,	
  3.6834e-08,	5.9364e-07,	4.1718e-06,	1.6454e-05,	3.8486e-05,	4.9315e-05,	1.8203e-05,	-3.1564e-05,	-2.4280e-05,	
  2.3983e-10,	5.0727e-09,	4.8454e-08,	2.7363e-07,	1.0001e-06,	2.4116e-06,	3.6486e-06,	2.7027e-06,	-7.7660e-07,	
  4.2446e-13,	1.1667e-11,	1.4848e-10,	1.1547e-09,	6.0917e-09,	2.2819e-08,	6.1434e-08,	1.1637e-07,	1.4244e-07,	
  7.7278e-17,	2.7897e-15,	4.7524e-14,	5.0663e-13,	3.7767e-12,	2.0819e-11,	8.7412e-11,	2.8309e-10,	7.0552e-10
  };

  for(int j = 0; j<(J+1); j++) {
    for(int l = 0; l<(L+1); l++) {
      EXPECT_FLOAT_EQ_REL_D(&laguerre->get_toGrid()[j+(J+1)*l], toGrid_correct[l+(L+1)*j], 1.e-4);
    }
  }
}

TEST_F(TestLaguerreTransform, toSpectral) {
  float toSpectral_correct[108] = {
  2.6473e-01,	-2.3410e-01,	2.0523e-01,	-1.7807e-01,	1.5255e-01,	-1.2861e-01,	1.0617e-01,	-8.5184e-02,	6.5589e-02,	
  3.7776e-01,	-1.4666e-01,	-1.3747e-02,	1.1788e-01,	-1.7796e-01,	2.0424e-01,	-2.0532e-01,	1.8830e-01,	-1.5901e-01,	
  2.4408e-01,	1.2512e-01,	-2.1509e-01,	1.6662e-01,	-6.7263e-02,	-3.2574e-02,	1.0756e-01,	-1.4859e-01,	1.5640e-01,	
  9.0449e-02,	1.6586e-01,	-5.9012e-02,	-6.7963e-02,	1.1505e-01,	-8.7511e-02,	2.3234e-02,	4.1266e-02,	-8.3087e-02,	
  2.0102e-02,	7.2353e-02,	4.7803e-02,	-5.4621e-02,	-3.0691e-03,	4.6398e-02,	-4.6940e-02,	1.6563e-02,	1.9539e-02,	
  2.6640e-03,	1.5570e-02,	2.8597e-02,	7.2029e-03,	-2.1728e-02,	3.6044e-03,	1.5610e-02,	-1.6816e-02,	3.4843e-03,	
  2.0323e-04,	1.7521e-03,	5.6991e-03,	7.6110e-03,	7.1340e-04,	-6.0001e-03,	7.8422e-04,	4.7645e-03,	-3.8895e-03,	
  8.3651e-06,	1.0043e-04,	4.9828e-04,	1.2628e-03,	1.5224e-03,	2.0952e-04,	-1.1986e-03,	-1.8063e-04,	1.0938e-03,	
  1.6685e-07,	2.6891e-06,	1.8897e-05,	7.4533e-05,	1.7434e-04,	2.2339e-04,	8.2456e-05,	-1.4298e-04,	-1.0998e-04,	
  1.3424e-09,	2.8393e-08,	2.7121e-07,	1.5316e-06,	5.5978e-06,	1.3498e-05,	2.0422e-05,	1.5128e-05,	-4.3468e-06,	
  3.0616e-12,	8.4157e-11,	1.0710e-09,	8.3288e-09,	4.3939e-08,	1.6459e-07,	4.4312e-07,	8.3935e-07,	1.0274e-06,	
  8.1481e-16,	2.9414e-14,	5.0109e-13,	5.3419e-12,	3.9821e-11,	2.1951e-10,	9.2166e-10,	2.9849e-09,	7.4389e-09
  };

  for(int j = 0; j<(J+1); j++) {
    for(int l = 0; l<(L+1); l++) {
      EXPECT_FLOAT_EQ_REL_D(&laguerre->get_toSpectral()[l+(L+1)*j], toSpectral_correct[l+(L+1)*j], 1.e-4);
    }
  }
}

TEST_F(TestLaguerreTransform, roots) {
  float roots_correct[12] = {
  1.1572e-01,	6.1176e-01,	1.5126e+00,	2.8338e+00,	4.5992e+00,	6.8445e+00,	
  9.6213e+00,	1.3006e+01,	1.7117e+01,	2.2151e+01,	2.8488e+01,	3.7099e+01
  };

  for(int j = 0; j<(J+1); j++) {
    EXPECT_FLOAT_EQ_REL_D(&laguerre->get_roots()[j], roots_correct[j], 1.e-4);
  }
}


